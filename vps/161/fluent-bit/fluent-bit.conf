[SERVICE]
    daemon off
    flush 5
    log_level warn
    parsers_file /fluent-bit/etc/parsers.conf
    http_server on
    http_listen 0.0.0.0
    http_port 2020
    health_check on

[INPUT]
    name tail
    alias caddy-access
    tag caddy.access
    path /var/log/caddy/access.log
    parser json
    refresh_interval 10
    db /fluent-bit/db/caddy.db

[FILTER]
    name grep
    match caddy.*
    regex request .+

[FILTER]
    name modify
    match caddy.*
    add app caddy
    add source vps
    add hostname ${HOSTNAME}

[OUTPUT]
    name http
    match caddy.*
    host ${VICTORIA_LOGS_HOST}
    port ${VICTORIA_LOGS_PORT}
    uri /insert/jsonline?_stream_fields=source,hostname,app&_msg_field=request&_time_field=ts
    format json_lines
    json_date_format iso8601
    compress gzip
    log_response_payload false
    retry_limit 5
